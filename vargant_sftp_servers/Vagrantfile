# -*- mode: ruby -*-
# vi: set ft=ruby :

require_relative 'env_loader'

Vagrant.configure("2") do |config|
  (1..3).each do |i|
    config.vm.define "sftp_server_#{i}" do |node|
      node.vm.box = "ubuntu/focal64"
      node.vm.hostname = "sftp-server-#{i}"
      node.vm.network "private_network", type: "dhcp"

      node.vm.provider "virtualbox" do |vb|
        vb.memory = VM_MEMORY
        vb.cpus = VM_CPUS.to_i
      end

      node.vm.provision "shell", inline: <<-SHELL
        apt-get update
        apt-get install -y openssh-server

        # Remove existing PasswordAuthentication and PubkeyAuthentication lines
        sed -i '/^#*PasswordAuthentication/d' /etc/ssh/sshd_config
        sed -i '/^#*PubkeyAuthentication/d' /etc/ssh/sshd_config

        # Add new configuration lines
        echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config
        echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config
        echo "PermitRootLogin no" >> /etc/ssh/sshd_config
        echo "AllowUsers #{SFTP_USERNAME} vagrant" >> /etc/ssh/sshd_config

        # Restart SSH service to apply changes
        systemctl restart sshd

        # Create user and set up SFTP directory
        useradd -m -d /home/#{SFTP_USERNAME} -s /bin/bash #{SFTP_USERNAME}
        echo "#{SFTP_USERNAME}:#{SFTP_PASSWORD}" | chpasswd
        mkdir -p /home/#{SFTP_USERNAME}/upload
        chown #{SFTP_USERNAME}:#{SFTP_USERNAME} /home/#{SFTP_USERNAME}/upload
        chmod 755 /home/#{SFTP_USERNAME}
      SHELL
    end
  end
end